{"version":3,"file":"load.js","sourceRoot":"","sources":["../../src/project/load.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2020-2022 OnFinality Limited authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\nimport fs from 'fs';\nimport path from 'path';\nimport yaml from 'js-yaml';\nimport {gte} from 'semver';\nimport {NETWORK_FAMILY, runnerMapping} from '../constants';\nimport {ProjectManifestV0_2_0} from '../project/versioned';\nexport function loadFromJsonOrYaml(file: string): unknown {\n  const {ext} = path.parse(file);\n  if (ext !== '.yaml' && ext !== '.yml' && ext !== '.json') {\n    throw new Error(`Extension ${ext} not supported`);\n  }\n  const rawContent = fs.readFileSync(file, 'utf-8');\n  return yaml.load(rawContent);\n}\n\nexport function getManifestPath(manifestDir: string, fileName?: string): string {\n  let manifestPath = manifestDir;\n  if (fs.existsSync(manifestDir) && fs.lstatSync(manifestDir).isDirectory()) {\n    const yamlFilePath = path.join(manifestDir, fileName ?? 'project.yaml');\n    const jsonFilePath = path.join(manifestDir, fileName ?? 'project.json');\n    if (fs.existsSync(yamlFilePath)) {\n      manifestPath = yamlFilePath;\n    } else if (fs.existsSync(jsonFilePath)) {\n      manifestPath = jsonFilePath;\n    } else {\n      throw new Error(`Could not find project manifest under dir ${manifestDir}`);\n    }\n  }\n  return manifestPath;\n}\n\nexport function getSchemaPath(manifestDir: string, fileName?: string): string {\n  const yamlFile = loadFromJsonOrYaml(getManifestPath(manifestDir, fileName));\n  if ((yamlFile as any).specVersion === '0.0.1') {\n    return path.join(manifestDir, (yamlFile as any).schema);\n  }\n  const project = yamlFile as ProjectManifestV0_2_0;\n  if (!project.schema) {\n    throw new Error(`Can't get schema in yaml file`);\n  }\n  if (!project.schema.file) {\n    throw new Error(`schemaPath expect to be schema.file`);\n  }\n  return path.join(manifestDir, project.schema.file);\n}\n\n// Only work for manifest specVersion >= 1.0.0\nexport function getProjectNetwork(rawManifest: unknown): NETWORK_FAMILY {\n  if (gte((rawManifest as any).specVersion, '1.0.0')) {\n    const network = runnerMapping[(rawManifest as any).runner.node.name as keyof typeof runnerMapping];\n    if (network === undefined) {\n      throw new Error(`Can not identify project network with runner node ${(rawManifest as any).runner.node.name}`);\n    }\n    return network;\n  } else {\n    throw new Error('Can not identify project network under spec version 1.0.0');\n  }\n}\n\n/**\n * @param path path to the file\n * @param identifier name to be used for logging purpose\n * @returns file content\n */\nexport function getFileContent(path: string, identifier: string): string {\n  if (!fs.existsSync(path)) {\n    const err_msg = `${identifier} file ${path} is does not exist`;\n    throw new Error(err_msg);\n  }\n\n  try {\n    return fs.readFileSync(path).toString();\n  } catch (error) {\n    const err_msg = `Failed to load ${identifier} file, ${error}`;\n    throw new Error(err_msg);\n  }\n}\n"]}