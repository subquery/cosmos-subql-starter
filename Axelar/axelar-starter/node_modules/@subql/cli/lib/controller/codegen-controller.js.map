{"version":3,"file":"codegen-controller.js","sourceRoot":"","sources":["../../src/controller/codegen-controller.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2020-2022 OnFinality Limited authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\nimport fs from 'fs';\nimport path from 'path';\nimport {promisify} from 'util';\nimport {getManifestPath, getSchemaPath, loadFromJsonOrYaml} from '@subql/common';\nimport {\n  isCustomDs,\n  isSubstrateTemplates,\n  RuntimeDatasourceTemplate as SubstrateDsTemplate,\n  CustomDatasourceTemplate as SubstrateCustomDsTemplate,\n} from '@subql/common-substrate';\nimport {\n  isTerraTemplates,\n  RuntimeDatasourceTemplate as TerraDsTemplate,\n  CustomDatasourceTemplate as TerraCustomDsTemplate,\n} from '@subql/common-terra';\nimport {\n  getAllEntitiesRelations,\n  getAllJsonObjects,\n  setJsonObjectType,\n  getTypeByScalarName,\n  GraphQLEntityField,\n  GraphQLJsonFieldType,\n  GraphQLEntityIndex,\n  getAllEnums,\n} from '@subql/utils';\nimport ejs from 'ejs';\nimport {upperFirst, uniq} from 'lodash';\nimport rimraf from 'rimraf';\n\ntype TemplateKind = SubstrateDsTemplate | SubstrateCustomDsTemplate | TerraDsTemplate | TerraCustomDsTemplate;\nlet MODEL_TEMPLATE_PATH = path.resolve(__dirname, '../template/model.ts.ejs');\nconst MODELS_INDEX_TEMPLATE_PATH = path.resolve(__dirname, '../template/models-index.ts.ejs');\nconst TYPES_INDEX_TEMPLATE_PATH = path.resolve(__dirname, '../template/types-index.ts.ejs');\nconst INTERFACE_TEMPLATE_PATH = path.resolve(__dirname, '../template/interface.ts.ejs');\nconst ENUM_TEMPLATE_PATH = path.resolve(__dirname, '../template/enum.ts.ejs');\nconst DYNAMIC_DATASOURCE_TEMPLATE_PATH = path.resolve(__dirname, '../template/datasource-templates.ts.ejs');\nconst TYPE_ROOT_DIR = 'src/types';\nconst MODEL_ROOT_DIR = 'src/types/models';\nconst exportTypes = {\n  models: false,\n  interfaces: false,\n  enums: false,\n  datasources: false,\n};\n\n// 4. Render entity data in ejs template and write it\nexport async function renderTemplate(templatePath: string, outputPath: string, templateData: ejs.Data): Promise<void> {\n  const data = await ejs.renderFile(templatePath, templateData);\n  await fs.promises.writeFile(outputPath, data);\n}\n\n// 3. Re-format the field of the entity\nexport interface ProcessedField {\n  name: string;\n  type: string;\n  required: boolean;\n  isEnum: boolean;\n  indexed: boolean;\n  unique?: boolean;\n  isArray: boolean;\n  isJsonInterface: boolean;\n}\n\nexport async function generateJsonInterfaces(projectPath: string, schema: string): Promise<void> {\n  const typesDir = path.join(projectPath, TYPE_ROOT_DIR);\n  const jsonObjects = getAllJsonObjects(schema);\n  const jsonInterfaces = jsonObjects.map((r) => {\n    const object = setJsonObjectType(r, jsonObjects);\n    const fields = processFields('jsonField', object.name, object.fields);\n    return {\n      interfaceName: object.name,\n      fields,\n    };\n  });\n\n  if (jsonInterfaces.length !== 0) {\n    const interfaceTemplate = {\n      props: {\n        jsonInterfaces,\n      },\n      helper: {\n        upperFirst,\n      },\n    };\n    try {\n      await renderTemplate(INTERFACE_TEMPLATE_PATH, path.join(typesDir, `interfaces.ts`), interfaceTemplate);\n      exportTypes.interfaces = true;\n    } catch (e) {\n      throw new Error(`When render json interfaces having problems.`);\n    }\n  }\n}\n\nexport async function generateEnums(projectPath: string, schema: string): Promise<void> {\n  const typesDir = path.join(projectPath, TYPE_ROOT_DIR);\n  const jsonObjects = getAllEnums(schema);\n  const enums = jsonObjects.map((r) => {\n    return {\n      name: r.name,\n      values: r.getValues().map((v) => v.name),\n    };\n  });\n\n  if (enums.length !== 0) {\n    const enumsTemplate = {\n      props: {\n        enums,\n      },\n    };\n    try {\n      await renderTemplate(ENUM_TEMPLATE_PATH, path.join(typesDir, `enums.ts`), enumsTemplate);\n      exportTypes.enums = true;\n    } catch (e) {\n      throw new Error(`When render enums having problems.`);\n    }\n  }\n}\n\nexport function processFields(\n  type: 'entity' | 'jsonField',\n  className: string,\n  fields: (GraphQLEntityField | GraphQLJsonFieldType)[],\n  indexFields: GraphQLEntityIndex[] = []\n): ProcessedField[] {\n  const fieldList: ProcessedField[] = [];\n  for (const field of fields) {\n    const injectField = {\n      name: field.name,\n      required: !field.nullable,\n      isArray: field.isArray,\n      isEnum: false,\n    } as ProcessedField;\n    if (type === 'entity') {\n      const [indexed, unique] = indexFields.reduce<[boolean, boolean]>(\n        (acc, indexField) => {\n          if (indexField.fields.includes(field.name)) {\n            acc[0] = true;\n            if (indexField.fields.length === 1 && indexField.unique) {\n              acc[1] = true;\n            } else if (indexField.unique === undefined) {\n              acc[1] = false;\n            }\n          }\n          return acc;\n        },\n        [false, undefined]\n      );\n      injectField.indexed = indexed;\n      injectField.unique = unique;\n    }\n    if ((field as GraphQLEntityField).isEnum) {\n      injectField.type = field.type;\n      injectField.isEnum = true;\n      injectField.isJsonInterface = false;\n    } else {\n      switch (field.type) {\n        default: {\n          injectField.type = getTypeByScalarName(field.type).tsType;\n          if (!injectField.type) {\n            throw new Error(\n              `Schema: undefined type \"${field.type.toString()}\" on field \"${\n                field.name\n              }\" in \"type ${className} @${type}\"`\n            );\n          }\n          injectField.isJsonInterface = false;\n          break;\n        }\n        case 'Json': {\n          if (field.jsonInterface === undefined) {\n            throw new Error(`On field ${field.name} type is Json but json interface is not defined`);\n          }\n          injectField.type = upperFirst(field.jsonInterface.name);\n          injectField.isJsonInterface = true;\n        }\n      }\n    }\n    fieldList.push(injectField);\n  }\n  return fieldList;\n}\n\nasync function prepareDirPath(path: string, recreate: boolean) {\n  try {\n    await promisify(rimraf)(path);\n    if (recreate) {\n      await fs.promises.mkdir(path, {recursive: true});\n    }\n  } catch (e) {\n    throw new Error(`Failed to prepare ${path}`);\n  }\n}\n\n//1. Prepare models directory and load schema\nexport async function codegen(projectPath: string, fileName?: string): Promise<void> {\n  const modelDir = path.join(projectPath, MODEL_ROOT_DIR);\n  const interfacesPath = path.join(projectPath, TYPE_ROOT_DIR, `interfaces.ts`);\n  await prepareDirPath(modelDir, true);\n  await prepareDirPath(interfacesPath, false);\n\n  const plainManifest = loadFromJsonOrYaml(getManifestPath(projectPath, fileName)) as {\n    specVersion: string;\n    templates?: TemplateKind[];\n  };\n  if (plainManifest.templates && plainManifest.templates.length !== 0) {\n    await generateDatasourceTemplates(projectPath, plainManifest.specVersion, plainManifest.templates);\n  }\n  const schemaPath = getSchemaPath(projectPath, fileName);\n\n  await generateJsonInterfaces(projectPath, schemaPath);\n  await generateModels(projectPath, schemaPath);\n  await generateEnums(projectPath, schemaPath);\n\n  if (exportTypes.interfaces || exportTypes.models || exportTypes.enums || exportTypes.datasources) {\n    try {\n      await renderTemplate(TYPES_INDEX_TEMPLATE_PATH, path.join(projectPath, TYPE_ROOT_DIR, `index.ts`), {\n        props: {\n          exportTypes,\n        },\n      });\n    } catch (e) {\n      throw new Error(`When render index in types having problems.`);\n    }\n    console.log(`* Types index generated !`);\n  }\n}\n\n// 2. Loop all entities and render it\nexport async function generateModels(projectPath: string, schema: string): Promise<void> {\n  const extractEntities = getAllEntitiesRelations(schema);\n  for (const entity of extractEntities.models) {\n    const baseFolderPath = '.../../base';\n    const className = upperFirst(entity.name);\n    const entityName = entity.name;\n    const fields = processFields('entity', className, entity.fields, entity.indexes);\n    const importJsonInterfaces = uniq(fields.filter((field) => field.isJsonInterface).map((f) => f.type));\n    const importEnums = fields.filter((field) => field.isEnum).map((f) => f.type);\n    const indexedFields = fields.filter((field) => field.indexed && !field.isJsonInterface);\n    const modelTemplate = {\n      props: {\n        baseFolderPath,\n        className,\n        entityName,\n        fields,\n        importJsonInterfaces,\n        importEnums,\n        indexedFields,\n      },\n      helper: {\n        upperFirst,\n      },\n    };\n    try {\n      await renderTemplate(\n        MODEL_TEMPLATE_PATH,\n        path.join(projectPath, MODEL_ROOT_DIR, `${className}.ts`),\n        modelTemplate\n      );\n    } catch (e) {\n      console.error(e);\n      throw new Error(`When render entity ${className} to schema having problems.`);\n    }\n    console.log(`* Schema ${className} generated !`);\n  }\n  const classNames = extractEntities.models.map((entity) => entity.name);\n  if (classNames.length !== 0) {\n    try {\n      await renderTemplate(MODELS_INDEX_TEMPLATE_PATH, path.join(projectPath, MODEL_ROOT_DIR, `index.ts`), {\n        props: {\n          classNames,\n        },\n        helper: {\n          upperFirst,\n        },\n      });\n      exportTypes.models = true;\n    } catch (e) {\n      throw new Error(`When render index in models having problems.`);\n    }\n    console.log(`* Models index generated !`);\n  }\n}\n\nexport async function generateDatasourceTemplates(\n  projectPath: string,\n  specVersion: string,\n  templates: TemplateKind[]\n): Promise<void> {\n  let props;\n  if (isSubstrateTemplates(templates, specVersion)) {\n    props = templates.map((t) => ({\n      name: t.name,\n      args: isCustomDs(t) ? 'Record<string, unknown>' : undefined,\n    }));\n  } else if (isTerraTemplates(templates, specVersion)) {\n    props = templates.map((t) => ({\n      name: t.name,\n      args: 'Record<string, unknown>',\n    }));\n    MODEL_TEMPLATE_PATH = path.resolve(__dirname, '../template/terramodel.ts.ejs');\n  } else {\n    throw new Error(`Generated datasource templates failed: unsupported templates`);\n  }\n  try {\n    await renderTemplate(DYNAMIC_DATASOURCE_TEMPLATE_PATH, path.join(projectPath, TYPE_ROOT_DIR, `datasources.ts`), {\n      props,\n    });\n    exportTypes.datasources = true;\n  } catch (e) {\n    console.error(e);\n    throw new Error(`Unable to generate datasource template constructors`);\n  }\n  console.log(`* Datasource template constructors generated !`);\n}\n"]}