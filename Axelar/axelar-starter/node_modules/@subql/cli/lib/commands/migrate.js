"use strict";
// Copyright 2020-2022 OnFinality Limited authors & contributors
// SPDX-License-Identifier: Apache-2.0
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const path_1 = tslib_1.__importDefault(require("path"));
const core_1 = require("@oclif/core");
const common_substrate_1 = require("@subql/common-substrate");
const common_terra_1 = require("@subql/common-terra");
const migrate_controller_1 = require("../controller/migrate-controller");
class Migrate extends core_1.Command {
    async run() {
        const { flags } = await this.parse(Migrate);
        const location = flags.location ? path_1.default.resolve(flags.location) : process.cwd();
        let manifest;
        try {
            manifest = (0, common_substrate_1.loadSubstrateProjectManifest)(location);
        }
        catch (e) {
            try {
                manifest = (0, common_terra_1.loadTerraProjectManifest)(location);
            }
            catch (e) {
                this.error(`Please validate project manifest before migrate. \n ${e}`);
            }
        }
        if (manifest.isV1_0_0) {
            this.log(`* You are already using manifest spec v1.0.0`);
        }
        else {
            console.log(`* Converting manifest to v1.0.0, please provide:`);
            const [project, chainTypesRelativePath] = await (0, migrate_controller_1.prepare)(location, manifest);
            await (0, migrate_controller_1.migrate)(location, project, manifest, chainTypesRelativePath);
            this.log('* Migration completed');
            process.exit(0);
        }
    }
}
exports.default = Migrate;
Migrate.description = 'Migrate Subquery project manifest to v1.0.0';
Migrate.flags = {
    force: core_1.Flags.boolean({ char: 'f' }),
    file: core_1.Flags.string(),
    location: core_1.Flags.string({ char: 'l', description: 'local folder to run migrate in' }),
};
//# sourceMappingURL=migrate.js.map