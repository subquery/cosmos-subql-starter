{"version":3,"file":"publish.js","sourceRoot":"","sources":["../../src/commands/publish.ts"],"names":[],"mappings":";AAAA,gEAAgE;AAChE,sCAAsC;;;AAEtC,2BAA4C;AAC5C,wDAAwB;AACxB,sCAA2C;AAC3C,0CAAwD;AACxD,yEAA8E;AAC9E,4DAA4B;AAE5B,MAAM,iBAAiB,GAAG,cAAI,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,EAAE,2BAA2B,CAAC,CAAC;AAEtF,MAAqB,OAAQ,SAAQ,cAAO;IAS1C,KAAK,CAAC,GAAG;;QACP,MAAM,EAAC,KAAK,EAAC,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;QAC1C,MAAM,QAAQ,GAAG,KAAK,CAAC,QAAQ,CAAC,CAAC,CAAC,cAAI,CAAC,OAAO,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC;QAC/E,MAAM,OAAO,GAAG,IAAA,kCAAyB,EAAC,QAAQ,CAAC,CAAC;QAEpD,mCAAmC;QACnC,IAAI;YACF,MAAM,eAAK,CAAC,GAAG,CAAC,CAAC,YAAY,EAAE,OAAO,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;SACrD;QAAC,OAAO,CAAC,EAAE;YACV,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;YACZ,IAAI,CAAC,KAAK,CAAC,yBAAyB,CAAC,CAAC;SACvC;QAED,IAAI,SAAiB,CAAC;QAEtB,IAAI,OAAO,CAAC,GAAG,CAAC,kBAAkB,EAAE;YAClC,SAAS,GAAG,OAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC;SAC5C;aAAM,IAAI,IAAA,eAAU,EAAC,iBAAiB,CAAC,EAAE;YACxC,IAAI;gBACF,SAAS,GAAG,MAAA,OAAO,CAAC,GAAG,CAAC,kBAAkB,mCAAI,IAAA,iBAAY,EAAC,iBAAiB,EAAE,MAAM,CAAC,CAAC;aACvF;YAAC,OAAO,CAAC,EAAE;gBACV,MAAM,IAAI,KAAK,CAAC,0CAA0C,iBAAiB,KAAK,CAAC,EAAE,CAAC,CAAC;aACtF;SACF;aAAM;YACL,MAAM,IAAI,KAAK,CAAC,kDAAkD,CAAC,CAAC;SACrE;QACD,MAAM,GAAG,GAAG,MAAM,IAAA,iCAAY,EAAC,OAAO,CAAC,QAAQ,EAAE,SAAS,CAAC,IAAI,EAAE,EAAE,KAAK,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;QAC3G,MAAM,IAAA,mCAAc,EAAC,QAAQ,EAAE,GAAG,CAAC,CAAC;QAEpC,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE;YACjB,IAAI,CAAC,GAAG,CAAC,oCAAoC,CAAC,CAAC;YAC/C,IAAI,CAAC,GAAG,CAAC,sCAAsC,GAAG,EAAE,CAAC,CAAC;SACvD;aAAM;YACL,IAAI,CAAC,GAAG,CAAC,GAAG,GAAG,EAAE,CAAC,CAAC;SACpB;IACH,CAAC;;AA5CH,0BA6CC;AA5CQ,mBAAW,GAAG,sCAAsC,CAAC;AAErD,aAAK,GAAG;IACb,QAAQ,EAAE,YAAK,CAAC,MAAM,CAAC,EAAC,IAAI,EAAE,GAAG,EAAE,WAAW,EAAE,+BAA+B,EAAC,CAAC;IACjF,IAAI,EAAE,YAAK,CAAC,MAAM,CAAC,EAAC,WAAW,EAAE,uBAAuB,EAAE,QAAQ,EAAE,KAAK,EAAC,CAAC;IAC3E,MAAM,EAAE,YAAK,CAAC,OAAO,CAAC,EAAC,IAAI,EAAE,GAAG,EAAE,WAAW,EAAE,iBAAiB,EAAE,QAAQ,EAAE,KAAK,EAAC,CAAC;CACpF,CAAC","sourcesContent":["// Copyright 2020-2022 OnFinality Limited authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\nimport {readFileSync, existsSync} from 'fs';\nimport path from 'path';\nimport {Command, Flags} from '@oclif/core';\nimport {getProjectRootAndManifest} from '@subql/common';\nimport {createIPFSFile, uploadToIpfs} from '../controller/publish-controller';\nimport Build from './build';\n\nconst ACCESS_TOKEN_PATH = path.resolve(process.env.HOME, '.subql/SUBQL_ACCESS_TOKEN');\n\nexport default class Publish extends Command {\n  static description = 'Upload this SubQuery project to IPFS';\n\n  static flags = {\n    location: Flags.string({char: 'f', description: 'from project or manifest path'}),\n    ipfs: Flags.string({description: 'IPFS gateway endpoint', required: false}),\n    output: Flags.boolean({char: 'o', description: 'Output IPFS CID', required: false}),\n  };\n\n  async run(): Promise<void> {\n    const {flags} = await this.parse(Publish);\n    const location = flags.location ? path.resolve(flags.location) : process.cwd();\n    const project = getProjectRootAndManifest(location);\n\n    // Ensure that the project is built\n    try {\n      await Build.run(['--location', project.root, '-s']);\n    } catch (e) {\n      this.log(e);\n      this.error('Failed to build project');\n    }\n\n    let authToken: string;\n\n    if (process.env.SUBQL_ACCESS_TOKEN) {\n      authToken = process.env.SUBQL_ACCESS_TOKEN;\n    } else if (existsSync(ACCESS_TOKEN_PATH)) {\n      try {\n        authToken = process.env.SUBQL_ACCESS_TOKEN ?? readFileSync(ACCESS_TOKEN_PATH, 'utf8');\n      } catch (e) {\n        throw new Error(`Failed to read SUBQL_ACCESS_TOKEN from ${ACCESS_TOKEN_PATH}: ${e}`);\n      }\n    } else {\n      throw new Error('Please provide SUBQL_ACCESS_TOKEN before publish');\n    }\n    const cid = await uploadToIpfs(project.manifest, authToken.trim(), flags.ipfs).catch((e) => this.error(e));\n    await createIPFSFile(location, cid);\n\n    if (!flags.output) {\n      this.log('Uploading SubQuery project to IPFS');\n      this.log(`SubQuery Project uploaded to IPFS: ${cid}`);\n    } else {\n      this.log(`${cid}`);\n    }\n  }\n}\n"]}